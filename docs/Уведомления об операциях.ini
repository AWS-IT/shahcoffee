Уведомления об операциях
Уведомления об операциях — это уведомления мерчанту о статусе выполнения платежа. На основании этих уведомлений магазин должен предоставлять покупателю услугу или товар.

Чтобы настроить уведомления:

В личном кабинете интернет-эквайринга перейдите в раздел Магазины.
На вкладке Терминалы нажмите Настроить и выберите нужный вариант получения уведомлений — почта, HTTP(S) или оба варианта.
Вы можете получать уведомления не только о статусах платежа — также есть уведомления о привязке карты, фискализации и привязке счета по QR. Такие уведомления отправляются только на NotificationURL, заданный в настройках терминала.

Платеж (NotificationPayment)
После проведения платежа через вызов метода Инициировать платеж вам будет отправлена информация о статусе платежа.

На электронную почту
Т‑Бизнес будет присылать письма с уведомлениями об успешных платежах в статусе CONFIRMED.

По HTTP(S)
При вызове методов:

Подтвердить списание и Отменить платеж — уведомление с информацией об операции отправляется через POST‑запрос на адрес NotificationURL.

Подтвердить платеж:

При двухстадийной оплате — уведомление с информацией об операции отправляется через POST‑запрос на адрес NotificationURL.

При одностадийной оплате — уведомление отправляется на ваш сайт на адрес NotificationURL и ждет ответа в течение 10 секунд. Сервис одновременно отправляет две нотификации — AUTHORIZED и CONFIRMED.

Для метода Провести платеж по сохраненным реквизитам логика такая же.

Привязать карту — уведомление отправляется на ваш сайт на адрес NotificationURL и ждет ответа в течение 10 секунд.

Если в NotificationURL используются порты, можно использовать порт 443 (HTTPS).


Список внешних сетей, которые использует Т-Банк
Дополнительные параметры
Чтобы включить дополнительные параметры DATA, обратитесь к своему персональному менеджеру.

В уведомлениях можно получать дополнительные параметры. Для этого передайте объект DATA с нужными параметрами. В ответе вернется параметр Data — учитывайте регистр.

Пример набора параметров:

Параметр	Значение
description	Описание.
name	ФИО.
order_number	Идентификатор заказа.
paymentId	Идентификатор платежа.
source*	Способ оплаты.
phone	Телефон.
terminalKey	Идентификатор терминала.
* При использовании платежной формы банка параметр source возвращается автоматически.

Чтобы получать POST‑запросы со статусами платежа, укажите URL в настройках терминала или передайте параметр NotificationURL в запросе метода Инициировать платеж. Если параметр передан, используется его значение, если нет — значение из настроек терминала.


Статусы платежа
Статус	Описание
AUTHORIZED	Операция авторизована. Деньги заблокированы на карте покупателя*.
CONFIRMED	Операция подтверждена. Деньги списаны с карты покупателя.
PARTIAL_REVERSED	Частичная отмена по авторизованной операции.
REVERSED	Полная отмена по авторизованной операции.
CANCELED	Операция отменена, когда была создана платежная ссылка.
PARTIAL_REFUNDED	Частичный возврат по подтвержденной операции.
REFUNDED	Полный возврат по подтвержденной операции.
REJECTED	Списание денег закончилась ошибкой.
DEADLINE_EXPIRED	Платеж не прошел проверку 3DS в срок и произошло автоматическое закрытие сессии**, которая превысила срок пребывания в статусе 3DS_CHECKING — более 36 часов.
* Подтвердить операцию можно через вызов метода Подтвердить списание или в личном кабинете интернет-эквайринга. По неподтвержденным операциям деньги не возвращаются.

** Чтобы получать уведомления об автоматическом закрытии сессии в статусе 3DS_CHECKING, напишите на acq_help@tbank.ru.

Ответ на HTTP(s)-уведомление
При успешной обработке уведомления вам нужно вернуть ответ HTTP CODE = 200 с телом сообщения OK — без тегов, заглавными английскими буквами.

Если ответ OK не получен, уведомление считается неуспешным. Сервис будет повторно отправлять его раз в час в течение 24 часов, а затем раз в сутки в течение месяца. Если за это время оно так и не будет доставлено, уведомление будет перемещено в архив.

Уведомления хранятся в архиве 90 дней. В течение этого времени вы можете запросить их повторную отправку.


Параметры в теле уведомления о платеже
Название параметра	Формат	Тип	Описание
TerminalKey	20 символов	string	Идентификатор терминала. Выдается мерчанту в Т‑Бизнес при заведении терминала.
Amount	10 символов	number	Сумма в копейках.
OrderId	36 символов	string	Идентификатор заказа в системе мерчанта. Должен быть уникальным для каждой операции.
Success	-	boolean	Успешность прохождения запроса — true или false.
Status	20 символов	string	Статус платежа.
PaymentId	20 символов	number	Идентификатор платежа в системе Т‑Бизнес.
ErrorCode	20 символов	string	Код ошибки.
Message	-	string	Краткое описание ошибки. Не передается в методе Подтвердить платеж. При возникновении ошибки в ответе API включается поле message, содержащее ее текстовое описание.
Details	-	string	Подробное описание ошибки. Не передается в методе Подтвердить платеж. При возникновении ошибки в ответе API включается поле message, содержащее ее текстовое описание.
RebillId	20 символов	number	Уникальный идентификатор сохраненных реквизитов карты покупателя.
CardId	-	number	Идентификатор карты в системе Т‑Бизнес.
Pan	-	string	Замаскированный номер карты или телефона.
ExpDate	-	string	Срок действия карты в формате MMYY.
Token	-	string	Подпись запроса.
Data	-	object	Дополнительные параметры платежа, которые передаются при создании заказа. Являются обязательными для платежей в рассрочку. В ответе возвращается параметр Data — учитывайте регистр.
Data.Route	-	string	Способ платежа. Значение TCB.
Data.Source	-	string	Источник платежа. Значение Installment.
Data.CreditAmount	-	number	Сумма выданного кредита в копейках. Возвращается только для платежей в рассрочку, если при вызове метода Подтвердить списание был передан параметр Source в значении Installment.

Пример уведомления о платеже
{
  "TerminalKey": "TBankTest",
  "Amount": 100000,
  "OrderId": "21050",
  "Success": true,
  "Status": "string",
  "PaymentId": 13660,
  "ErrorCode": "0",
  "Message": "string",
  "Details": "string",
  "RebillId": 3207469334,
  "CardId": 10452089,
  "Pan": "string",
  "ExpDate": "0229",
  "Token": "7241ac8307f349afb7bb9dda760717721bbb45950b97c67289f23d8c69cc7b96",
  "Data": {
    "Route": "TCB",
    "Source": "Installment",
    "CreditAmount": 10000
  }
}

Привязка (NotificationAddCard)
Для мерчантов со своей платежной формой.

После привязки карты через метод Привязать карту вам будет отправлена информация о статусе привязки.


Параметры в теле уведомления о привязке карты

Пример уведомления о привязке карты
Фискализация (NotificationFiscalization)
Если вы работаете по схеме интеграции «Маркетплейс», такой тип уведомлений не отправляется.

При подключенной онлайн-кассе по результату фискализации вам придет уведомление с фискальными данными. Чтобы включить такие уведомления, обратитесь в поддержку банка.


Параметры в теле уведомления о фискализации
Название параметра	Формат	Тип	Описание
TerminalKey	20 символов	string	Идентификатор терминала. Выдается мерчанту в Т‑Бизнес при заведении терминала.
OrderId	36 символов	string	Идентификатор заказа в системе мерчанта. Должен быть уникальным для каждой операции.
Success	-	boolean	Успешность прохождения запроса — true или false.
Status	20 символов	string	Статус фискализации. Всегда RECEIPT.
PaymentId	20 символов	number	Идентификатор платежа в системе Т‑Бизнес.
ErrorCode	20 символов	string	Код ошибки.
ErrorMessage	-	string	Описание ошибки.
Details	-	string	Подробное описание ошибки.
Amount	10 символов	number	Сумма в копейках.
FiscalNumber	-	integer	Номер чека в смене.
ShiftNumber	-	integer	Номер смены.
ReceiptDatetime	-	string	Дата и время документа из ФН.
FnNumber	-	string	Номер ФН.
EcrRegNumber	-	string	Регистрационный номер ККТ.
FiscalDocumentNumber	-	integer	Фискальный номер документа.
FiscalDocumentAttribute	-	integer	Фискальный признак документа.
Receipt	-	object	Состав чека. Подробнее — в методе Инициировать платеж.
Type	-	string	Признак расчета.
Token	-	string	Подпись запроса.
Ofd	-	string	Наименование оператора фискальных данных.
Url	-	string	URL-адрес с копией чека.
QrCodeUrl	-	string	URL-адрес с QR-кодом для проверки чека в ФНС.
CalculationPlace	-	string	Место осуществления расчетов.
CashierName	-	string	Имя кассира.
SettlePlace	-	string	Место нахождения (установки) ККМ.

Пример уведомления о фискализации
{
  "TerminalKey": "TBankTest",
  "OrderId": "21050",
  "Success": true,
  "Status": "RECEIPT",
  "PaymentId": 13660,
  "ErrorCode": "0",
  "ErrorMessage": "string",
  "Amount": 100000,
  "FiscalNumber": 0,
  "ShiftNumber": 0,
  "ReceiptDatetime": "string",
  "FnNumber": "string",
  "EcrRegNumber": "string",
  "FiscalDocumentNumber": 0,
  "FiscalDocumentAttribute": 0,
  "Receipt": {
    "FfdVersion": "string",
    "ClientInfo": {
      "Birthdate": "string",
      "Citizenship": "string",
      "DocumentСode": "21",
      "DocumentData": "string",
      "Address": "string"
    },
    "Taxation": "osn",
    "Email": "a@test.ru",
    "Phone": "+79031234567",
    "Customer": "string",
    "CustomerInn": "string",
    "Items": [
      {
        "AgentData": {
          "AgentSign": "paying_agent",
          "OperationName": "Позиция чека",
          "Phones": [
            "+790912312398"
          ],
          "ReceiverPhones": [
            "+79221210697",
            "+79098561231"
          ],
          "TransferPhones": [
            "+79221210697"
          ],
          "OperatorName": "TBank",
          "OperatorAddress": "г. Тольятти",
          "OperatorInn": "7710140679"
        },
        "SupplierInfo": {
          "Phones": [
            "+79221210697",
            "+79098561231"
          ],
          "Name": "ООО Вендор товара",
          "Inn": "7710140679"
        },
        "Name": "Наименование товара 1",
        "Price": 10000,
        "Quantity": 1,
        "Amount": 10000,
        "Tax": "vat10",
        "PaymentMethod": "full_payment",
        "PaymentObject": "goods_with_marking_code",
        "UserData": "Данные пользователя test@tbank.ru",
        "Excise": "12.2",
        "CountryCode": "056",
        "DeclarationNumber": "12345678901",
        "MeasurementUnit": "шт",
        "MarkProcessingMode": "string",
        "MarkCode": {
          "MarkCodeType": "EAN8",
          "Value": "12345678"
        },
        "MarkQuantity": {
          "Numerator": 1,
          "Denominator": 2
        },
        "SectoralItemProps": {
          "FederalId": "001",
          "Date": "21.11.2020",
          "Number": "123/43",
          "Value": "test value SectoralItemProps"
        }
      }
    ],
    "Payments": [
      {
        "Cash": 90000,
        "Electronic": 50000,
        "AdvancePayment": 0,
        "Credit": 0,
        "Provision": 0
      }
    ]
  },
  "Type": "string",
  "Token": "7241ac8307f349afb7bb9dda760717721bbb45950b97c67289f23d8c69cc7b96",
  "Ofd": "string",
  "Url": "string",
  "QrCodeUrl": "string",
  "CalculationPlace": "string",
  "CashierName": "string",
  "SettlePlace": "string"
}

Статус привязки счета по QR (NotificationQr)
Такие уведомления будут приходить только по статусам ACTIVE и INACTIVE.

После успешной привязки счета по QR вам будет отправлена информация о статусе привязки счета и подпись запроса.


Параметры в теле уведомления о статусе привязки счета по QR
Название параметра	Формат	Тип	Описание
TerminalKey	-	string	Идентификатор терминала. Выдается мерчанту в Т-Бизнес при заведении терминала.
RequestKey	-	string	Идентификатор запроса на привязку счета.
AccountToken	-	string	Идентификатор привязки счета. Назначается банком-эмитентом.
BankMemberId	-	string	Идентификатор банка-эмитента покупателя, который будет совершать оплату по привязанному счету. Заполнен, если статус ACTIVE.
BankMemberName	-	string	Наименование банка-эмитента. Заполнен, если передан BankMemberId.
NotificationType	-	string	Тип уведомления. Всегда LINKACCOUNT.
Success	-	boolean	Успешность прохождения запроса — true или false.
ErrorCode	20 символов	string	Код ошибки.
Message	-	string	Краткое описание ошибки.
Token	-	string	Подпись запроса.
Status	-	string	Статус привязки.

Пример уведомления о статусе привязки счета по QR
{
  "TerminalKey": "TBankTest",
  "RequestKey": "13021e10-a3ed-4f14-bcd1-823b5ac37390",
  "AccountToken": "70LSS7DN18SJQRS10006DNPKLJL24B05",
  "BankMemberId": "5555",
  "BankMemberName": "string",
  "NotificationType": "LINKACCOUNT",
  "Success": true,
  "ErrorCode": "0",
  "Message": "string",
  "Token": "871199b37f207f0c4f721a37cdcc71dfcea880b4a4b85e3cf852c5dc1e99a8d6",
  "Status": "ACTIVE"
}

Проверить токен уведомлений
При получении уведомления и перед его обработкой проверьте токен:

Соберите массив всех переданных в нотификации параметров в виде пар ключ:значение — кроме параметра Token и вложенных объектов (Data, Receipt):

[{"TerminalKey": "1234567890DEMO"},{"OrderId": "000000"},{"Success": "true"},{"Status": "AUTHORIZED"},{"PaymentId": "0000000"},{"ErrorCode": "0"},{"Amount": "1111"},{"CardId": "000000"},{"Pan": "200000******0000"},{"ExpDate": "1111"},{"RebillId": "000000"}]


Добавьте в массив пару {"Password": "Значение пароля"}. Пароль можно найти в личном кабинете интернет-эквайринга.

[{"TerminalKey": "1234567890DEMO"},{"OrderId": "000000"},{"Success": "true"},{"Status": "AUTHORIZED"},{"PaymentId": "0000000"},{"ErrorCode": "0"},{"Amount": "1111"},{"CardId": "000000"},{"Pan": "200000******0000"},{"ExpDate": "1111"},{"RebillId": "000000"},{"Password": "11111111111"}]


Отсортируйте массив по алфавиту по ключу:

[{"Amount": "1111"},{"CardId": "000000"},{"ErrorCode": "0"},{"ExpDate": "1111"},{"OrderId": "000000"},{"Pan": "200000******0000"},{"Password": "11111111111"},{"PaymentId": "0000000"},{"RebillId": "000000"},{"Status": "AUTHORIZED"},{"Success": "true"},{"TerminalKey": "1234567890DEMO"}]


Конкатенируйте только значения пар в одну строку:

111100000001111000000200000******0000111111111110000000000000AUTHORIZEDtrue1234567890DEMO

Примените к строке хеш-функцию SHA-256 (с поддержкой UTF-8):

1c0964277d0213349243065a0d5b838b8e90d2d25f740d0f2767836e710e80c8


Пример генерации токена
private static final String PASSWORD_KEY = "Password"; private static final String PASSWORD_VALUE = "12345678";
private String generateToken(final Map<String, String> parameters) throws UnsupportedEncodingException,
NoSuchAlgorithmException { final Map<String, String> sortedParameters = new TreeMap<String, String>(parameters);
if (sortedParameters.containsKey(TOKEN)) {
sortedParameters.remove(TOKEN);
}
sortedParameters.put(PASSWORD_KEY, PASSWORD_VALUE); final String paramString =
Joiner.on("").skipNulls().join(sortedParameters.values()); return
calculateSha256(paramString);
}


Пример сравнения токенов
private boolean checkToken(final Map<String,String> params, final String expectedToken) {
final String actualToken = params.get(TOKEN);
return !(expectedToken == null || !expectedToken.equals(actualToken));
}